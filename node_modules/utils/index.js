var fs = require("fs");
global.positions_valid = false;
global.history_valid = false;
global.news_valid = false;
global.reports_valid = false;

global.cache_positions = [];
global.cache_history = [];
global.cache_news = [];
global.cache_reports = [];

module.exports = {
	getPositions : function(funk){
		var readyToReturn = false;
		if( !global.positions_valid ){
			global.db.all("SELECT * from positions ORDER BY order_num" , function(err, _positions){
				if(!err){
					var postions_ajusted = {};
					for (var i = 0; i < _positions.length; i++) {
						if(postions_ajusted[_positions[i].position_name] == undefined)
							postions_ajusted[_positions[i].position_name] = {
								leader:[],
								assistant:[]
							};

						if(_positions[i].assistant == "FALSE")
							postions_ajusted[_positions[i].position_name].leader.push(_positions[i].member_name);
						else{
							postions_ajusted[_positions[i].position_name].assistant.push(_positions[i].member_name);
						}
					};
					global.cache_positions = postions_ajusted;
					global.positions_valid = true;
					funk("Positions", postions_ajusted);
				}else
					funk("Positions", []);

				readyToReturn = true;
			});
		}else{
			funk("Positions", global.cache_positions);
		}
	},

	getNews : function(funk){
		var readyToReturn = false;

		if( !global.news_valid ){
			global.db.all("SELECT * from news ORDER BY order_num" , function(err, _news){
				if(!err){
					global.cache_news = _news;
					global.news_valid = true;
					funk("News", _news);
				}
				else
					funk("News", []);

				readyToReturn = true;
			});
		}else{
			funk("News", global.cache_news);
		}
	},

	getReports : function(funk){
		var readyToReturn = false;

		if( !global.reports_valid ){
			global.db.all("SELECT * from reports ORDER BY order_num" , function(err, _reports){
				if(!err){
					global.cache_reports = _reports;
					global.reports_valid = true;
					funk("Reports", _reports);
				}
				else
					funk("Reports", []);

				readyToReturn = true;
			});
		}else{
			funk("Reports", global.cache_reports);
		}
	},


	getHistory : function(funk){
		var readyToReturn = false;
		if( !global.history_valid ){
			 fs.readdir("public/history" , function(err, _history){
				
				if(!err){
					_history = _history.slice(0,10);

					for (var i = 0; i < _history.length; i++) {
						var filename = _history[i];
						var name = filename.split(".")[0].split("_");
						_history[i] = {
							href:"/history/"+filename,
							name:name[1]+"/"+name[2]+"/"+name[0],
							date:new Date(name[1]+"/"+name[2]+"/"+name[0]).getTime()
						};
					};

					_history.sort(function(a,b){
						  if (a.date < b.date)
						     return 1;
						  if (a.date > b.date)
						    return -1;
						  return 0;
					});

					global.cache_history = _history;
					global.history_valid = true;
					funk("History", _history);
				}
				else
					funk("History", []);

				readyToReturn = true;
			});
		}else{
			funk("History", global.cache_history);
		}
	},

}